<html>

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        pre {
            background-color: lightgrey;
            padding: 8px;
        }
    </style>
</head>

<body>
    <div id="targetDiv" class="container-fluid"></div>

    <script type="text/markdown">
# This is a demo

## Code sample

```
var mytext = 'demo';
console.log(mytext + '!!!');
```

another block:

```
var mytext = 'demo2';
console.log(mytext + '222!!!');
```


## What just happened?

* the file is added as a new script derived from the query in the URL
* the page finds the script of type "text/markdown" in the page
* it calls showdown to render the page
* TODO: add an extension/hook to call custom code when a code block is reached
    </script>

    <script src="https://unpkg.com/showdown@1.9.0/dist/showdown.min.js"></script>
    <script>
        var inCode = false;
        var codeChunk = '';

        var myext = {
            type: 'output',
            regex: /.*/g, // new RegExp('.*'),
            replace: function (text) {
                // console.log('!!!' + text + '!!!');

                if (text.startsWith('</' + 'code>')) {
                    // console.log('@@@' + codeChunk);
                    eval(codeChunk);
                    codeChunk = '';
                    inCode = false;
                }

                if (inCode) {
                    codeChunk += text + '\n';
                } else if (text.startsWith('<pre><code>')) {
                    inCode = true;
                    codeChunk += text.substring('<pre><code>'.length) + '\n';
                }

                if (inCode) {
                    // console.log('###' + code + '###');
                    // eval(code);
                }
                return text;
            }
        };

        function run() {
            // TODO check how to load dynamically by loading an external file
            // var file = document.location.search.substring(6);
            // document.writeln("<script type='text/markdown' src='" + file + "'><" + "/script>");

            showdown.extension('myext', myext); // register extension 'myext'

            var text = document.scripts[0].text,
                target = document.getElementById('targetDiv'),
                converter = new showdown.Converter({ extensions: ['myext'] }),
                html = converter.makeHtml(text);

            target.innerHTML = html;
        }

        run();
    </script>
</body>

</html>